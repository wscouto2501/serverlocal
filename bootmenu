#!/bin/bash
set -e

#################################
# Detecta ambiente (ISO ou CLI)
#################################
if [ -d /target ]; then
  ROOT="/target"
  echo "[BOOTMENU] Ambiente de instalação (ISO) detectado"
  RUN="curtin in-target --"
else
  ROOT=""
  echo "[BOOTMENU] Sistema em execução (CLI) detectado"
  RUN=""
fi

#################################
# 3. Script MENU PRÉ-LOGIN
#################################

MENU_URL="https://raw.githubusercontent.com/wscouto2501/serverlocal/main/menucontent"
DESTINO="$ROOT/usr/local/bin/prelogin-menu.sh"
TMP_FILE="$(mktemp)"

# Baixa o conteúdo
if curl -fsSL "$MENU_URL" -o "$TMP_FILE"; then
  # Verifica se não está vazio
  if [ -s "$TMP_FILE" ] && \
     head -n 1 "$TMP_FILE" | grep -Eq '^#!(/usr/bin/env bash|/bin/bash)' && \
     bash -n "$TMP_FILE" 2>/dev/null; then
    install -m 755 "$TMP_FILE" "$DESTINO"
  fi
fi
rm -f "$TMP_FILE"

$RUN chmod +x /usr/local/bin/prelogin-menu.sh

#################################
# 4. Serviço systemd PRELOGIN
#################################
cat > "$ROOT/etc/systemd/system/prelogin-menu.service" << 'EOF'
[Unit]
Description=Menu antes do login
After=systemd-user-sessions.service
Before=getty@tty1.service
Conflicts=getty@tty1.service

[Service]
ExecStart=/usr/local/bin/prelogin-menu.sh
StandardInput=tty
StandardOutput=tty
TTYPath=/dev/tty1
TTYReset=yes
TTYVHangup=yes
Restart=always

[Install]
WantedBy=multi-user.target
EOF

#################################
# 5. Ativação correta
#################################
$RUN systemctl disable getty@tty1.service || true
$RUN systemctl daemon-reload
$RUN systemctl enable prelogin-menu.service

echo "[BOOTMENU] Menu pré-login instalado com sucesso"
