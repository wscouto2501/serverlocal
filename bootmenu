#!/bin/bash
set -e

#################################
# Detecta ambiente (ISO ou CLI)
#################################
if [ -d /target ]; then
  ROOT="/target"
  echo "[BOOTMENU] Ambiente de instalação (ISO) detectado"
  RUN="curtin in-target --"
else
  ROOT=""
  echo "[BOOTMENU] Sistema em execução (CLI) detectado"
  RUN=""
fi

#################################
# 3. Script MENU PRÉ-LOGIN
#################################
cat > "$ROOT/usr/local/bin/prelogin-menu.sh" << 'EOF'
#!/bin/bash

stty -echo

while true; do
  clear
  [ -f /etc/issue ] && cat /etc/issue && echo

  echo "====================================="
  echo "   MENU DE ACESSO AO SERVIDOR"
  echo "====================================="
  echo "1) Status do servidor"
  echo "2) Reiniciar servidor"
  echo "3) Desligar servidor"
  echo "====================================="
  echo "4) Atualizar servidor"
  echo "5) Reiniciar o Túnel"
  echo "6) Reiniciar Serviço Docker"
  echo "====================================="

  stty echo
  read -p "Escolha uma opção: " opcao
  stty -echo

  case "$opcao" in
    1)
      clear
      uptime
      free -h
      df -h
      read -p "ENTER para voltar..."
      ;;
    2)
      systemctl reboot
      exit 0
      ;;
    3)
      systemctl poweroff
      exit 0
      ;;
    4)
      apt update && apt upgrade -y
      read -p "ENTER para voltar..."
      ;;
    5)
      systemctl restart cloudflared || true
      read -p "ENTER para voltar..."
      ;;
    6)
      systemctl restart docker || true
      read -p "ENTER para voltar..."
      ;;
    7)
      stty echo
      exec /sbin/agetty --noclear tty1 linux
      ;;
    *) 
      read -p "Opção inválida tente novamente..."
      sleep 1 ;;
  esac
done
EOF

$RUN chmod +x /usr/local/bin/prelogin-menu.sh

#################################
# 4. Serviço systemd PRELOGIN
#################################
cat > "$ROOT/etc/systemd/system/prelogin-menu.service" << 'EOF'
[Unit]
Description=Menu antes do login
After=systemd-user-sessions.service
Before=getty@tty1.service
Conflicts=getty@tty1.service

[Service]
ExecStart=/usr/local/bin/prelogin-menu.sh
StandardInput=tty
StandardOutput=tty
TTYPath=/dev/tty1
TTYReset=yes
TTYVHangup=yes
Restart=always

[Install]
WantedBy=multi-user.target
EOF

#################################
# 5. Ativação correta
#################################
$RUN systemctl disable getty@tty1.service || true
$RUN systemctl daemon-reload
$RUN systemctl enable prelogin-menu.service

echo "[BOOTMENU] Menu pré-login instalado com sucesso"
