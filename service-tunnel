#!/bin/bash
set -e

echo "[BOOTMENU] Iniciando configuração..."

# -----------------------------
# Detecta ambiente (ISO ou CLI)
# -----------------------------
if [ -d /target ] && command -v curtin >/dev/null 2>&1; then
  ROOT="/target"
  MODE="ISO"
else
  ROOT=""
  MODE="CLI"
fi

run() {
  if [ "$MODE" = "ISO" ]; then
    curtin in-target -- "$@"
  else
    "$@"
  fi
}

# -----------------------------
# Garante diretórios
# -----------------------------
mkdir -p "$ROOT/usr/local/bin"
mkdir -p "$ROOT/etc/systemd/system"

# -----------------------------
# 1. Script cloudflared-check
# -----------------------------
cat > "$ROOT/usr/local/bin/cloudflared-check.sh" << 'EOF'
#!/bin/bash
set -euo pipefail

CLOUDFLARED="/usr/local/bin/cloudflared"
CONFIG_YML="/etc/cloudflared/config.yml"

cloudflared_ok() {
  [ -f "$CLOUDFLARED" ] && \
  [ -s "$CLOUDFLARED" ] && \
  chmod +x "$CLOUDFLARED" 2>/dev/null && \
  "$CLOUDFLARED" --version >/dev/null 2>&1
}

if ! cloudflared_ok; then
  rm -f "$CLOUDFLARED"
  curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloud0flared-linux-amd64 \
    -o "$CLOUDFLARED"
  chmod +x "$CLOUDFLARED"
fi

if cloudflared_ok; then
  if [ ! -f "$CONFIG_YML" ]; then
    curl -fsSL https://souweverton.com.br/config | bash
  else
    curl -fsSL https://souweverton.com.br/bootconfig | bash
  fi
fi
EOF

run chmod +x /usr/local/bin/cloudflared-check.sh

# -----------------------------
# 2. Serviço cloudflared-check
# -----------------------------
cat > "$ROOT/etc/systemd/system/cloudflared-check.service" << 'EOF'
[Unit]
Description=Verifica e instala/atualiza cloudflared no boot
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/cloudflared-check.sh
Restart=always
RestartSec=30
StartLimitIntervalSec=0
KillMode=control-group

[Install]
WantedBy=multi-user.target
EOF

run chmod 644 /etc/systemd/system/cloudflared-check.service
run systemctl daemon-reload
run systemctl enable cloudflared-check.service

echo "[BOOTMENU] cloudflared-check configurado com sucesso"
