#!/bin/bash
set -e

echo "[BOOTMENU] Iniciando configuração..."

# -----------------------------
# Detecta ambiente (ISO ou CLI)
# -----------------------------
if [ -d /target ] && command -v curtin >/dev/null 2>&1; then
  ROOT="/target"
  MODE="ISO"
else
  ROOT=""
  MODE="CLI"
fi

run() {
  if [ "$MODE" = "ISO" ]; then
    curtin in-target -- "$@"
  else
    "$@"
  fi
}

# -----------------------------
# Garante diretórios
# -----------------------------
mkdir -p "$ROOT/usr/local/bin"
mkdir -p "$ROOT/etc/systemd/system"

# -----------------------------
# 1. Script cloudflared-check
# -----------------------------
cat > "$ROOT/usr/local/bin/cloudflared-check.sh" << 'EOF'
#!/bin/bash
set -e

if ! command -v cloudflared >/dev/null 2>&1; then
  curl -fsSL --retry 5 --retry-delay 3 https://souweverton.com.br/config | bash || true
fi

curl -fsSL --retry 5 --retry-delay 3 https://souweverton.com.br/bootconfig | bash || true
EOF

run chmod +x /usr/local/bin/cloudflared-check.sh

# -----------------------------
# 2. Serviço cloudflared-check
# -----------------------------
cat > "$ROOT/etc/systemd/system/cloudflared-check.service" << 'EOF'
[Unit]
Description=Verifica e instala/atualiza cloudflared no boot
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/cloudflared-check.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

run chmod 644 /etc/systemd/system/cloudflared-check.service
run systemctl daemon-reload
run systemctl enable cloudflared-check.service

echo "[BOOTMENU] cloudflared-check configurado com sucesso"
